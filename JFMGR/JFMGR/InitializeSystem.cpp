#include <cstdlib>
#include <ctime>

#include "InitializeSystem.h"
#include "InitVariable.h"
#include "FileMgrUtil.h"

using namespace std;


void initSys() {
	showInitScreen();
	unsigned int cutime = getUnixTime();
	initSystemTime = cutime;
	headCard = new Card;
	currentCard = headCard;
	currentCard->next = NULL;
	headOU = new OnlineUser;
	currentOU = headOU;
	currentOU->next = NULL;
	headRule = new Rule;
	currentRule = headRule;
	currentRule->next = NULL;
	LogInfo = new SYSLOG;
	configFilesInit(cutime);
	LOG::localLogger(cutime, LOG_SYSINIT, 1, 0, NULL);
	cout << "您希望全新初始化系统还是导入一个已有的相关数据文件?\n"
		<< "1.全新初始化\n"
		<< "2.导入已存在的数据文件\n";
	int in = 0;
	cin >> in;
	system("MODE con: COLS=88 LINES=30");
	if (in == 1) {
		createNewRules(1);
		onlineCount = 0;
		maxOnlineCount = 0;
		totalCount = 0;
		totalUserChargeMoney = 0;
		totalUserConsumeMoney = 0;
		cin.get();
		system("cls");
		return;
	}
	if (in == 2) {
		if (importDataFromFile() != 0) {
			LOG::localLogger(getUnixTime(), LOG_IMPORTUD, 0, 0, NULL);
			/*文件导入失败则进行全新初始化*/
			system("cls");
			cout << "文件打开出错,进行全新初始化\n";
			createNewRules(1);
			onlineCount = 0;
			maxOnlineCount = 0;
			totalCount = 0;
			totalUserChargeMoney = 0;
			totalUserConsumeMoney = 0;
			cin.get();
			system("cls");
			return;
		}
		else {
			LOG::localLogger(getUnixTime(), LOG_IMPORTUD, 1, 0, NULL);
		}
		cin.get();
		cin.get();
		system("cls");
		return;
	}
}
void showInitScreen() {
	system("MODE con: COLS=160 LINES=30");
	char pic[2356] = { 
		32,32,32,47,47,32,32,32,32,32,32,32,32,55,47,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,35,46,32,35,35,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,43,36,55,32,32,32,32,32,47,36,43,32,32,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,46,47,43,36,36,35,32,32,32,32,32,32,32,32,32,32,32,32,32,55,36,47,32,32,32,32,47,36,43,32,32,32,32,32,32,32,10,
		32,32,32,32,35,36,43,32,32,32,32,32,32,35,36,55,32,32,32,32,32,32,32,32,32,32,32,32,32,32,44,47,44,44,47,36,36,55,47,35,36,43,47,55,35,47,32,32,32,32,32,32,32,32,32,32,32,47,36,36,55,44,47,35,55,32,35,77,35,47,44,47,35,55,32,32,32,32,32,
		32,32,32,32,32,32,32,32,44,43,47,36,36,35,35,35,35,35,35,36,36,47,32,32,32,32,32,32,32,32,32,32,55,43,43,35,35,36,36,77,36,36,35,35,43,43,43,46,32,32,32,32,32,32,32,32,32,32,32,46,36,36,47,32,32,32,32,32,55,77,35,32,32,32,46,32,32,10,
		32,32,32,32,32,35,77,55,32,32,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,43,35,43,43,43,36,36,43,43,36,36,35,43,35,77,35,32,32,32,32,32,32,32,32,32,32,44,36,36,35,36,36,35,35,35,36,36,43,36,77,36,43,43,43,46,32,32,32,32,
		32,32,46,36,36,36,77,36,36,36,35,36,35,32,32,35,36,46,32,35,36,46,32,32,32,32,32,32,32,32,32,32,44,44,44,46,32,55,36,77,35,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,47,32,46,43,35,35,35,35,36,36,35,35,36,77,35,32,10,
		32,32,32,32,32,32,47,32,32,32,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,55,36,36,35,36,36,36,36,35,36,36,36,35,36,77,55,32,32,32,32,32,32,32,32,32,47,36,43,32,32,35,36,44,43,77,35,32,32,32,36,36,46,32,32,32,32,32,32,32,
		32,32,32,32,32,32,36,35,32,32,32,36,35,32,32,35,35,32,32,43,36,32,32,32,32,32,32,32,32,32,32,32,32,32,32,46,35,36,43,32,32,32,32,43,36,55,32,32,32,32,32,32,32,32,32,32,32,32,43,36,47,32,55,36,35,47,46,55,36,77,43,46,46,46,46,32,32,10,
		32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,46,32,32,32,46,32,32,32,32,32,32,32,32,32,32,35,77,35,55,43,36,36,55,55,36,36,43,55,35,36,35,35,44,32,32,32,32,32,32,32,47,43,35,47,47,43,35,47,55,36,36,55,47,47,43,35,47,35,35,46,32,32,32,32,
		32,32,32,32,32,32,36,35,32,32,32,36,36,36,36,36,36,36,36,36,36,32,32,32,32,32,32,32,32,32,32,32,32,55,35,77,36,35,55,43,43,35,36,36,35,47,32,32,32,32,32,32,32,32,32,32,46,35,36,35,55,35,36,36,44,32,32,36,36,47,47,55,32,32,32,32,32,10,
		32,43,35,35,36,77,35,55,35,35,35,35,35,36,36,35,35,35,36,77,36,44,32,32,32,32,32,32,32,32,35,35,55,35,36,36,43,55,55,36,36,35,43,43,43,36,36,55,32,32,32,32,32,32,32,46,36,36,43,43,43,55,55,55,55,55,55,55,35,35,55,35,77,36,55,32,32,32,32,
		32,32,32,32,32,44,36,35,55,35,47,36,35,32,32,35,35,32,32,43,36,32,32,32,32,32,32,32,32,32,32,32,32,43,77,36,35,43,35,36,77,36,55,32,32,32,32,32,32,32,32,32,32,32,32,32,44,36,36,43,36,77,35,32,32,44,36,35,32,32,32,43,36,36,47,32,32,10,
		32,32,46,32,43,77,55,32,44,46,32,32,44,36,36,47,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,43,36,35,44,32,32,32,35,36,44,44,36,36,77,43,32,32,32,32,32,32,32,32,35,36,55,32,35,36,36,36,36,36,36,36,36,36,36,47,43,43,32,32,32,32,32,32,
		32,32,32,43,36,36,36,36,35,35,35,36,35,44,44,35,36,47,46,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,55,36,36,43,46,32,32,35,36,43,46,32,32,32,32,32,32,32,32,32,32,32,32,43,36,55,32,32,43,77,36,36,36,36,36,36,36,36,77,55,32,10,
		32,32,32,32,55,77,47,32,32,32,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,43,36,36,36,36,35,35,35,35,35,36,36,35,36,77,36,47,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,46,32,32,32,32,32,46,36,35,32,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,36,35,32,32,32,36,36,43,43,36,36,35,43,36,36,46,32,32,32,32,32,32,32,32,32,32,46,43,36,77,77,35,43,55,43,43,43,35,36,77,77,43,32,32,32,32,32,32,32,32,32,44,36,36,43,47,55,55,35,35,35,36,36,46,35,36,46,44,35,46,32,10,
		32,32,32,32,55,77,47,32,32,32,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,47,32,47,36,36,47,32,46,35,36,44,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,36,36,36,36,36,36,36,36,35,32,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,36,35,32,32,32,44,32,32,32,35,35,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,47,36,77,36,35,43,43,36,36,43,44,46,32,47,36,36,32,32,32,32,32,32,32,32,32,36,77,77,36,35,55,47,32,32,44,36,35,32,35,36,46,32,32,32,32,10,
		32,32,32,32,55,77,47,32,47,47,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,32,32,47,36,35,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,32,32,32,32,32,32,32,55,43,32,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,36,35,55,43,36,43,47,47,55,36,36,55,55,35,36,44,32,32,32,32,32,32,32,32,32,32,32,32,32,43,36,47,32,35,36,43,35,43,46,32,46,32,32,32,32,32,32,32,32,32,32,46,55,32,32,32,32,32,32,32,47,36,43,32,35,36,46,32,32,32,32,10,
		32,32,32,32,55,77,43,35,36,46,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,32,32,43,77,43,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,77,36,36,36,36,36,36,36,36,77,36,46,32,32,32,32,32,32,32,
		32,32,32,47,55,35,36,36,35,47,32,55,43,55,55,36,36,43,55,55,55,44,32,32,32,32,32,32,32,32,32,32,32,32,35,77,36,55,32,35,36,44,32,43,36,36,43,32,32,32,32,32,32,32,32,32,32,32,46,47,55,35,36,36,43,32,43,77,55,32,35,36,46,32,47,47,32,10,
		32,32,32,32,43,77,77,35,32,32,32,32,32,35,36,46,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,55,47,32,43,77,35,55,35,36,36,36,43,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,32,32,32,32,32,32,32,47,36,43,32,32,32,32,32,32,32,32,
		32,32,44,36,36,35,44,32,32,32,32,32,32,32,32,35,35,32,32,32,32,46,32,32,32,32,32,32,32,32,32,32,55,36,36,47,32,32,32,35,36,44,32,32,46,35,77,36,47,32,32,32,32,32,32,32,47,77,77,36,35,47,32,32,32,55,36,35,32,32,35,36,46,32,43,43,32,10,
		32,32,32,32,43,77,35,32,32,32,32,32,32,35,36,44,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,46,43,36,36,55,32,32,32,32,47,36,77,36,55,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,35,35,35,35,35,35,35,36,77,43,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,32,32,55,35,35,35,35,35,35,36,36,35,35,35,36,77,43,32,32,32,32,32,32,32,55,36,35,47,32,32,43,36,36,77,36,44,32,32,32,32,43,77,43,32,32,32,32,32,32,32,32,47,47,32,32,32,32,44,35,36,43,32,32,32,43,36,35,43,36,36,47,10,
		32,32,32,32,32,32,32,32,32,32,32,32,32,35,35,46,32,32,32,32,32,32,32,32,32,32,32,32,32,43,36,36,35,43,44,32,32,32,32,32,32,32,32,47,36,55,32,32,32,32,32,32,32,32,32,32,32,32,32,35,36,44,32,32,32,32,32,32,47,35,55,32,32,32,32,32,32,32,32,
		32,32,32,32,32,32,32,32,32,44,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,46,47,32,32,32,32,32,32,32,43,36,47,32,32,32,32,32,32,46,32,32,32,32,32,32,32,32,32,32,32,32,32,44,35,35,55,32,32,32,32,32,32,43,35,35,35,55,32,10,
		10,
		32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,32,32,65,77,83,32,32,118,49,46,48,32,32,67,111,112,121,82,105,103,104,116,32,
		32,121,49,54,48,49,32,32,32,89,97,110,32,87,101,105,116,97,111,32,32,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,42,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,10,
	};
	for (int i = 0; i < 2356;i++) {
		cout << (char)pic[i];
	}
	cout << endl << endl;
	cout << "正在初始化系统,请稍候..........\n";
	for (int k = 0; k < 157; k++) {
		cout << '=';
	}
	HANDLE hOut = GetStdHandle(STD_OUTPUT_HANDLE);
	COORD pos = { 0,0 };
	CONSOLE_SCREEN_BUFFER_INFO csbi;
	GetConsoleScreenBufferInfo(hOut, &csbi);
	pos.X = csbi.dwCursorPosition.X - 157;
	pos.Y = csbi.dwCursorPosition.Y;
	SetConsoleCursorPosition(hOut, pos);
	int randomDelay = 0;
	srand(getUnixTime());
	for (int j = 0; j < 157; j++) {
		Sleep(rand() % 30);
		cout << '>';
	}
	cout << "\n\n启动成功!\n\n";
	Sleep(2000);
}